# ğŸ’³ M9 â€” ê²°ì œ/êµ¬ë… ì‹œìŠ¤í…œ (Business Layer) ì‹œë‚˜ë¦¬ì˜¤

> **ëª©ì **: ì§€ì† ê°€ëŠ¥í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ êµ¬ì¶• ë° í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ ê³¼ê¸ˆ ì²´ê³„ ì™„ì„±  
> **ì˜ì¡´ì„±**: M1(ê³„ì •), M8(ì»¨ì„¤í„´íŠ¸ ìƒë‹´)  
> **Last Updated**: 2025-12-06

---

## ğŸ“‹ ê³µí†µ ì •ì˜

### êµ¬ë… í”Œëœ (PlanType)
| í”Œëœ | ì›” ìš”ê¸ˆ | ì„¤ëª… | ì£¼ìš” ê¸°ëŠ¥ |
|------|--------|------|----------|
| `FREE` | â‚©0 | ê¸°ë³¸ ë¬´ë£Œ | ë°ì´í„° ì…ë ¥, ì§„ë‹¨ 1íšŒ/ì›” |
| `BASIC` | â‚©29,900 | ì¼ë°˜ê³  ì¤€ë¹„ | ë¬´ì œí•œ ì§„ë‹¨, AI ì¡°ì–¸ |
| `PREMIUM` | â‚©49,900 | íŠ¹ëª©/ìì‚¬ê³  ì¤€ë¹„ | BASIC + ìƒë‹´ 2íšŒ/ì›” |
| `VIP` | â‚©99,900 | ì „ë¬¸ ì»¨ì„¤íŒ… | PREMIUM + ìƒë‹´ ë¬´ì œí•œ |

### êµ¬ë… ìƒíƒœ (SubscriptionStatus)
| ìƒíƒœ | ì„¤ëª… |
|------|------|
| `ACTIVE` | í™œì„± êµ¬ë… ì¤‘ |
| `TRIAL` | ì²´í—˜ ê¸°ê°„ (7ì¼) |
| `PAST_DUE` | ê²°ì œ ì‹¤íŒ¨, ìœ ì˜ˆ ê¸°ê°„ |
| `CANCELLED` | ì·¨ì†Œë¨ (ê¸°ê°„ ë§Œë£Œ ì „ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥) |
| `EXPIRED` | ë§Œë£Œë¨ |

### ê²°ì œ ìƒíƒœ (PaymentStatus)
| ìƒíƒœ | ì„¤ëª… |
|------|------|
| `PENDING` | ê²°ì œ ëŒ€ê¸° |
| `COMPLETED` | ê²°ì œ ì™„ë£Œ |
| `FAILED` | ê²°ì œ ì‹¤íŒ¨ |
| `REFUNDED` | í™˜ë¶ˆ ì™„ë£Œ |
| `CANCELLED` | ì·¨ì†Œë¨ |

### ê°€ì¡± í• ì¸
| ì¡°ê±´ | í• ì¸ìœ¨ |
|------|--------|
| ìë…€ 1ëª… | 0% |
| ìë…€ 2ëª… | 10% |
| ìë…€ 3ëª… ì´ìƒ | 20% |

---

## âœ… WP9.0 â€” êµ¬ë… í”Œëœ ì¡°íšŒ

> **ëª©ì **: ì‚¬ìš©ìê°€ êµ¬ë… ê°€ëŠ¥í•œ í”Œëœ ì •ë³´ í™•ì¸

### Scenario WP9.0-1: ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìê°€ í”Œëœ ëª©ë¡ ì¡°íšŒ

**Given:**
- ë¹„ë¡œê·¸ì¸ ìƒíƒœì˜ ì‚¬ìš©ìê°€ ìˆë‹¤.

**When:**
- ìš”ê¸ˆì œ í˜ì´ì§€ì— ì ‘ì†í•œë‹¤.

**Then:**
- ëª¨ë“  í”Œëœ(FREE, BASIC, PREMIUM, VIP)ì˜ ì •ë³´ê°€ í‘œì‹œëœë‹¤:
  - í”Œëœëª…, ì›” ìš”ê¸ˆ, ì£¼ìš” ê¸°ëŠ¥
  - "ì‹œì‘í•˜ê¸°" ë²„íŠ¼ (ë¡œê·¸ì¸ ìœ ë„)

**ì„ í–‰ Scenario:** ì—†ìŒ

---

### Scenario WP9.0-2: í•™ë¶€ëª¨ê°€ í˜„ì¬ í”Œëœê³¼ ë¹„êµí•˜ì—¬ ì¡°íšŒ

**Given:**
- í•™ë¶€ëª¨ ê³„ì •ì´ ë¡œê·¸ì¸ë˜ì–´ ìˆë‹¤.
- í˜„ì¬ BASIC í”Œëœì„ êµ¬ë… ì¤‘ì´ë‹¤.

**When:**
- ìš”ê¸ˆì œ í˜ì´ì§€ë¥¼ ì¡°íšŒí•œë‹¤.

**Then:**
- ëª¨ë“  í”Œëœ ì •ë³´ê°€ í‘œì‹œëœë‹¤.
- í˜„ì¬ êµ¬ë… ì¤‘ì¸ BASIC í”Œëœì— "í˜„ì¬ í”Œëœ" í‘œì‹œê°€ ëœë‹¤.
- ìƒìœ„ í”Œëœ(PREMIUM, VIP)ì—ëŠ” "ì—…ê·¸ë ˆì´ë“œ" ë²„íŠ¼ì´ í‘œì‹œëœë‹¤.
- í•˜ìœ„ í”Œëœ(FREE)ì—ëŠ” "ë‹¤ìš´ê·¸ë ˆì´ë“œ" ë²„íŠ¼ì´ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.0-3: í”Œëœë³„ ê¸°ëŠ¥ ìƒì„¸ ì¡°íšŒ

**Given:**
- ì‚¬ìš©ìê°€ ìš”ê¸ˆì œ í˜ì´ì§€ì— ìˆë‹¤.

**When:**
- íŠ¹ì • í”Œëœì˜ "ìì„¸íˆ ë³´ê¸°"ë¥¼ í´ë¦­í•œë‹¤.

**Then:**
- í•´ë‹¹ í”Œëœì˜ ìƒì„¸ ê¸°ëŠ¥ ëª©ë¡ì´ í‘œì‹œëœë‹¤:
  - ì§„ë‹¨ íšŸìˆ˜
  - AI ê¸°ëŠ¥ ì‚¬ìš©ëŸ‰
  - ìƒë‹´ ì˜ˆì•½ ê°€ëŠ¥ íšŸìˆ˜
  - ë¦¬í¬íŠ¸ ìƒì„± ê¸°ëŠ¥

**ì„ í–‰ Scenario:** ì—†ìŒ

---

## âœ… WP9.1 â€” ê²°ì œ í”Œë¡œìš° (PG ì—°ë™)

> **ëª©ì **: PG ì—°ë™ì„ í†µí•œ ì•ˆì „í•œ ê²°ì œ ì²˜ë¦¬

### Scenario WP9.1-1: í•™ë¶€ëª¨ê°€ í”Œëœ êµ¬ë… ê²°ì œ ì„±ê³µ

**Given:**
- í•™ë¶€ëª¨ ê³„ì •ì´ ë¡œê·¸ì¸ë˜ì–´ ìˆë‹¤.
- í˜„ì¬ êµ¬ë…ì´ ì—†ê±°ë‚˜ FREE í”Œëœì´ë‹¤.
- ìœ íš¨í•œ ì¹´ë“œ ì •ë³´ë¥¼ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

**When:**
- PREMIUM í”Œëœì„ ì„ íƒí•˜ê³  ê²°ì œë¥¼ ì§„í–‰í•œë‹¤.
- PGì—ì„œ ì„±ê³µ Webhookì´ ìˆ˜ì‹ ëœë‹¤.

**Then:**
- payments í…Œì´ë¸”ì— status=COMPLETEDì¸ ê²°ì œ ê¸°ë¡ì´ ìƒì„±ëœë‹¤.
- subscriptions í…Œì´ë¸”ì— status=ACTIVEì¸ êµ¬ë…ì´ ìƒì„±ëœë‹¤.
- User.hasPremiumì´ trueë¡œ ì—…ë°ì´íŠ¸ëœë‹¤.
- í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥(ì»¨ì„¤í„´íŠ¸ ìƒë‹´ ì˜ˆì•½ ë“±)ì´ ì ê¸ˆ í•´ì œëœë‹¤.
- "êµ¬ë…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤" ì•Œë¦¼ì´ ì „ì†¡ëœë‹¤.

**ì„ í–‰ Scenario:** WP1.1-3 (í•™ë¶€ëª¨ ë¡œê·¸ì¸)

---

### Scenario WP9.1-2: ê²°ì œ ì‹¤íŒ¨ ì‹œ êµ¬ë… ë¹„í™œì„±

**Given:**
- í•™ë¶€ëª¨ê°€ ê²°ì œë¥¼ ì‹œë„í–ˆë‹¤.
- PGì—ì„œ "ì”ì•¡ ë¶€ì¡±"ìœ¼ë¡œ ì‹¤íŒ¨ ì‘ë‹µì„ ë°˜í™˜í•œë‹¤.

**When:**
- ì‹¤íŒ¨ Webhookì´ ìˆ˜ì‹ ëœë‹¤.

**Then:**
- payments í…Œì´ë¸”ì— status=FAILEDì¸ ê¸°ë¡ì´ ìƒì„±ëœë‹¤.
- êµ¬ë… ìƒíƒœëŠ” ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤ (ê¸°ì¡´ ìƒíƒœ ìœ ì§€ ë˜ëŠ” ë¯¸ìƒì„±).
- "ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨ì„ ì‹œë„í•´ ì£¼ì„¸ìš”" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.
- 3ì¼ ì´ë‚´ ì¬ì‹œë„ ì•ˆë‚´ê°€ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** ì—†ìŒ

---

### Scenario WP9.1-3: ê¸°ì¡´ êµ¬ë…ìê°€ í”Œëœ ì—…ê·¸ë ˆì´ë“œ

**Given:**
- í•™ë¶€ëª¨ê°€ BASIC í”Œëœì„ êµ¬ë… ì¤‘ì´ë‹¤.
- êµ¬ë… ê¸°ê°„ì´ 15ì¼ ë‚¨ì•˜ë‹¤.

**When:**
- PREMIUM í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œë¥¼ ì„ íƒí•˜ê³  ê²°ì œí•œë‹¤.

**Then:**
- ë‚¨ì€ ê¸°ê°„ì— ëŒ€í•œ ì°¨ì•¡ë§Œ ê²°ì œëœë‹¤ (í”„ë¡œë ˆì´ì…˜).
- ì¦‰ì‹œ PREMIUM í”Œëœ ê¸°ëŠ¥ì´ í™œì„±í™”ëœë‹¤.
- ë‹¤ìŒ ê²°ì œì¼ë¶€í„° PREMIUM ìš”ê¸ˆì´ ì ìš©ëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.1-4: ê¸°ì¡´ êµ¬ë…ìê°€ í”Œëœ ë‹¤ìš´ê·¸ë ˆì´ë“œ

**Given:**
- í•™ë¶€ëª¨ê°€ PREMIUM í”Œëœì„ êµ¬ë… ì¤‘ì´ë‹¤.

**When:**
- BASIC í”Œëœìœ¼ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œë¥¼ ìš”ì²­í•œë‹¤.

**Then:**
- í˜„ì¬ ê²°ì œ ê¸°ê°„ ì¢…ë£Œê¹Œì§€ PREMIUM ê¸°ëŠ¥ì´ ìœ ì§€ëœë‹¤.
- ë‹¤ìŒ ê²°ì œì¼ë¶€í„° BASIC í”Œëœì´ ì ìš©ëœë‹¤.
- "ë‹¤ìŒ ê²°ì œì¼ë¶€í„° BASIC í”Œëœì´ ì ìš©ë©ë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.1-5: ìë™ ê°±ì‹  ê²°ì œ ì„±ê³µ

**Given:**
- í•™ë¶€ëª¨ì˜ êµ¬ë… ê°±ì‹ ì¼ì´ ì˜¤ëŠ˜ì´ë‹¤.
- ë“±ë¡ëœ ì¹´ë“œê°€ ìœ íš¨í•˜ë‹¤.

**When:**
- ì‹œìŠ¤í…œì´ ìë™ ê²°ì œë¥¼ ì‹œë„í•œë‹¤.

**Then:**
- ê²°ì œê°€ ì„±ê³µí•˜ê³  êµ¬ë…ì´ 1ê°œì›” ì—°ì¥ëœë‹¤.
- "êµ¬ë…ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤" ì•Œë¦¼ì´ ì „ì†¡ëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.1-6: ìë™ ê°±ì‹  ê²°ì œ ì‹¤íŒ¨ ì‹œ ìœ ì˜ˆ ê¸°ê°„

**Given:**
- í•™ë¶€ëª¨ì˜ êµ¬ë… ê°±ì‹ ì¼ì´ ì˜¤ëŠ˜ì´ë‹¤.
- ë“±ë¡ëœ ì¹´ë“œ ê²°ì œê°€ ì‹¤íŒ¨í•œë‹¤.

**When:**
- ìë™ ê²°ì œê°€ ì‹¤íŒ¨í•œë‹¤.

**Then:**
- êµ¬ë… ìƒíƒœê°€ PAST_DUEë¡œ ë³€ê²½ëœë‹¤.
- 7ì¼ê°„ ìœ ì˜ˆ ê¸°ê°„ì´ ë¶€ì—¬ëœë‹¤ (ê¸°ëŠ¥ ê³„ì† ì‚¬ìš© ê°€ëŠ¥).
- "ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. 7ì¼ ì´ë‚´ì— ê²°ì œ ìˆ˜ë‹¨ì„ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”" ì•Œë¦¼ì´ ì „ì†¡ëœë‹¤.
- 7ì¼ í›„ì—ë„ ê²°ì œ ì‹¤íŒ¨ ì‹œ êµ¬ë…ì´ EXPIREDë¡œ ë³€ê²½ëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

## âœ… WP9.2 â€” êµ¬ë… ìƒíƒœ ê´€ë¦¬

> **ëª©ì **: êµ¬ë… ì¡°íšŒ, ì·¨ì†Œ, ê°±ì‹  ê´€ë¦¬

### Scenario WP9.2-1: í•™ë¶€ëª¨ê°€ í˜„ì¬ êµ¬ë… ìƒíƒœ ì¡°íšŒ

**Given:**
- í•™ë¶€ëª¨ê°€ PREMIUM í”Œëœì„ êµ¬ë… ì¤‘ì´ë‹¤.
- ë‹¤ìŒ ê²°ì œì¼ì´ 2025-01-15ì´ë‹¤.

**When:**
- "ë‚´ êµ¬ë…" í˜ì´ì§€ë¥¼ ì¡°íšŒí•œë‹¤.

**Then:**
- ë‹¤ìŒ ì •ë³´ê°€ í‘œì‹œëœë‹¤:
  - í˜„ì¬ í”Œëœ: PREMIUM
  - êµ¬ë… ìƒíƒœ: ACTIVE
  - ë‹¤ìŒ ê²°ì œì¼: 2025-01-15
  - ê²°ì œ ê¸ˆì•¡: â‚©49,900 (ë˜ëŠ” ê°€ì¡± í• ì¸ ì ìš© ê¸ˆì•¡)
  - ë“±ë¡ëœ ê²°ì œ ìˆ˜ë‹¨
  - ì´ë²ˆ ë‹¬ ì‚¬ìš© í˜„í™© (ìƒë‹´ 2/2íšŒ ì‚¬ìš©)

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.2-2: í•™ë¶€ëª¨ê°€ êµ¬ë… ì·¨ì†Œ

**Given:**
- í•™ë¶€ëª¨ê°€ PREMIUM í”Œëœì„ êµ¬ë… ì¤‘ì´ë‹¤.
- êµ¬ë… ê¸°ê°„ì´ 20ì¼ ë‚¨ì•˜ë‹¤.

**When:**
- "êµ¬ë… ì·¨ì†Œ" ë²„íŠ¼ì„ í´ë¦­í•˜ê³  í™•ì¸í•œë‹¤.

**Then:**
- êµ¬ë… ìƒíƒœê°€ CANCELLEDë¡œ ë³€ê²½ëœë‹¤.
- ë‚¨ì€ 20ì¼ê°„ì€ í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ì„ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- "êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. 2025-01-XXê¹Œì§€ í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.
- ê¸°ê°„ ë§Œë£Œ 3ì¼ ì „ ì¬êµ¬ë… ì•ˆë‚´ ì•Œë¦¼ì´ ì „ì†¡ëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.2-3: ì·¨ì†Œëœ êµ¬ë… ì¬í™œì„±í™”

**Given:**
- í•™ë¶€ëª¨ê°€ êµ¬ë…ì„ ì·¨ì†Œí–ˆë‹¤ (status=CANCELLED).
- ì•„ì§ ê¸°ê°„ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ë‹¤.

**When:**
- "êµ¬ë… ì¬í™œì„±í™”" ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.

**Then:**
- êµ¬ë… ìƒíƒœê°€ ACTIVEë¡œ ë³µì›ëœë‹¤.
- ë‹¤ìŒ ê²°ì œì¼ì— ìë™ ê²°ì œê°€ ì¬ê°œëœë‹¤.
- "êµ¬ë…ì´ ì¬í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** WP9.2-2

---

### Scenario WP9.2-4: ë§Œë£Œëœ êµ¬ë…ìê°€ ì¬êµ¬ë…

**Given:**
- í•™ë¶€ëª¨ì˜ ì´ì „ êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆë‹¤ (status=EXPIRED).
- User.hasPremiumì´ falseì´ë‹¤.

**When:**
- ë‹¤ì‹œ PREMIUM í”Œëœì„ ì„ íƒí•˜ê³  ê²°ì œí•œë‹¤.

**Then:**
- ìƒˆë¡œìš´ êµ¬ë…ì´ ìƒì„±ëœë‹¤.
- ì¦‰ì‹œ í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ì´ í™œì„±í™”ëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

### Scenario WP9.2-5: ê²°ì œ ìˆ˜ë‹¨ ë³€ê²½

**Given:**
- í•™ë¶€ëª¨ê°€ êµ¬ë… ì¤‘ì´ë‹¤.
- ìƒˆë¡œìš´ ì¹´ë“œë¡œ ë³€ê²½í•˜ë ¤ í•œë‹¤.

**When:**
- "ê²°ì œ ìˆ˜ë‹¨ ë³€ê²½"ì—ì„œ ìƒˆ ì¹´ë“œ ì •ë³´ë¥¼ ì…ë ¥í•œë‹¤.

**Then:**
- PGì—ì„œ ì¹´ë“œ ìœ íš¨ì„±ì„ ê²€ì¦í•œë‹¤.
- ìœ íš¨í•œ ê²½ìš° ë‹¤ìŒ ê²°ì œë¶€í„° ìƒˆ ì¹´ë“œê°€ ì‚¬ìš©ëœë‹¤.
- "ê²°ì œ ìˆ˜ë‹¨ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1

---

## âœ… WP9.3 â€” ê°€ì¡± í• ì¸ ìë™ ì ìš©

> **ëª©ì **: ê°€ì¡± êµ¬ì„±ì› ìˆ˜ì— ë”°ë¥¸ ìë™ í• ì¸

### Scenario WP9.3-1: ìë…€ 2ëª…ì¸ í•™ë¶€ëª¨ì—ê²Œ í• ì¸ ìë™ ì ìš©

**Given:**
- í•™ë¶€ëª¨ì˜ ê°€ì¡± ê³„ì •ì— ìë…€ê°€ 2ëª… ì—°ê²°ë˜ì–´ ìˆë‹¤.
- í•™ë¶€ëª¨ê°€ PREMIUM í”Œëœì„ êµ¬ë…í•˜ë ¤ í•œë‹¤.

**When:**
- ê²°ì œ í˜ì´ì§€ì— ì§„ì…í•œë‹¤.

**Then:**
- ì›ë˜ ê¸ˆì•¡: â‚©49,900
- ê°€ì¡± í• ì¸ (10%): -â‚©4,990
- ìµœì¢… ê²°ì œ ê¸ˆì•¡: â‚©44,910
- "ê°€ì¡± í• ì¸ì´ ìë™ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** WP1.3-2 (ê°€ì¡± ì—°ê²°)

---

### Scenario WP9.3-2: ìë…€ ì¶”ê°€ ì‹œ ë‹¤ìŒ ê²°ì œë¶€í„° í• ì¸ ì ìš©

**Given:**
- í•™ë¶€ëª¨ê°€ ìë…€ 1ëª…ìœ¼ë¡œ PREMIUM í”Œëœì„ êµ¬ë… ì¤‘ì´ë‹¤.
- í• ì¸ ì—†ì´ â‚©49,900ì„ ê²°ì œ ì¤‘ì´ë‹¤.

**When:**
- ìƒˆë¡œìš´ ìë…€ê°€ ê°€ì¡± ê³„ì •ì— ì¶”ê°€ëœë‹¤.

**Then:**
- "ë‹¤ìŒ ê²°ì œë¶€í„° 10% ê°€ì¡± í• ì¸ì´ ì ìš©ë©ë‹ˆë‹¤" ì•Œë¦¼ì´ í‘œì‹œëœë‹¤.
- ë‹¤ìŒ ê²°ì œì¼ì— â‚©44,910ì´ ê²°ì œëœë‹¤.

**ì„ í–‰ Scenario:** WP9.1-1, WP1.3-2

---

### Scenario WP9.3-3: ìë…€ 3ëª… ì´ìƒ ìµœëŒ€ í• ì¸ ì ìš©

**Given:**
- í•™ë¶€ëª¨ì˜ ê°€ì¡± ê³„ì •ì— ìë…€ê°€ 3ëª… ì—°ê²°ë˜ì–´ ìˆë‹¤.

**When:**
- VIP í”Œëœì„ êµ¬ë…í•˜ë ¤ í•œë‹¤.

**Then:**
- ì›ë˜ ê¸ˆì•¡: â‚©99,900
- ê°€ì¡± í• ì¸ (20%): -â‚©19,980
- ìµœì¢… ê²°ì œ ê¸ˆì•¡: â‚©79,920
- ì¶”ê°€ ìë…€ê°€ ì—°ê²°ë˜ì–´ë„ 20%ê°€ ìµœëŒ€ í• ì¸ìœ¨ì´ë‹¤.

**ì„ í–‰ Scenario:** WP1.3-2

---

## âœ… WP9.4 â€” M8 í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ ì—°ë™

> **ëª©ì **: êµ¬ë… ìƒíƒœì— ë”°ë¥¸ M8 ìƒë‹´ ê¸°ëŠ¥ ì ‘ê·¼ ì œì–´

### Scenario WP9.4-1: êµ¬ë… í™œì„±í™” ì‹œ ìƒë‹´ ì˜ˆì•½ ê°€ëŠ¥

**Given:**
- í•™ë¶€ëª¨ê°€ PREMIUM ë˜ëŠ” VIP í”Œëœì„ êµ¬ë…í–ˆë‹¤.
- êµ¬ë… ìƒíƒœê°€ ACTIVEì´ë‹¤.

**When:**
- ì»¨ì„¤í„´íŠ¸ ìƒë‹´ ì˜ˆì•½ì„ ì‹œë„í•œë‹¤.

**Then:**
- ì •ìƒì ìœ¼ë¡œ ì˜ˆì•½ì´ ì§„í–‰ëœë‹¤.
- ì´ë²ˆ ë‹¬ ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜ê°€ í‘œì‹œëœë‹¤ (PREMIUM: 2íšŒ, VIP: ë¬´ì œí•œ).

**ì„ í–‰ Scenario:** WP9.1-1, WP8.2-1

---

### Scenario WP9.4-2: FREE/BASIC í”Œëœì—ì„œ ìƒë‹´ ì˜ˆì•½ ì‹œ ì—…ê·¸ë ˆì´ë“œ ì•ˆë‚´

**Given:**
- í•™ë¶€ëª¨ê°€ FREE ë˜ëŠ” BASIC í”Œëœì´ë‹¤.

**When:**
- ì»¨ì„¤í„´íŠ¸ ìƒë‹´ ì˜ˆì•½ì„ ì‹œë„í•œë‹¤.

**Then:**
- 403 Forbiddenê³¼ í•¨ê»˜ "ìƒë‹´ ì˜ˆì•½ì€ PREMIUM ì´ìƒ í”Œëœì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤" ë©”ì‹œì§€ê°€ ë°˜í™˜ëœë‹¤.
- "í”Œëœ ì—…ê·¸ë ˆì´ë“œ" ë²„íŠ¼ì´ í‘œì‹œëœë‹¤.

**ì„ í–‰ Scenario:** WP1.1-3

---

### Scenario WP9.4-3: êµ¬ë… ë§Œë£Œ ì‹œ ìƒë‹´ ì˜ˆì•½ ì°¨ë‹¨

**Given:**
- í•™ë¶€ëª¨ì˜ PREMIUM êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆë‹¤ (status=EXPIRED).
- User.hasPremiumì´ falseë¡œ ë³€ê²½ë˜ì—ˆë‹¤.

**When:**
- ì»¨ì„¤í„´íŠ¸ ìƒë‹´ ì˜ˆì•½ì„ ì‹œë„í•œë‹¤.

**Then:**
- 403 Forbiddenê³¼ í•¨ê»˜ "êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ ë°˜í™˜ëœë‹¤.
- "ì¬êµ¬ë…í•˜ê¸°" ë²„íŠ¼ì´ í‘œì‹œëœë‹¤.
- ê¸°ì¡´ ì˜ˆì•½ëœ ìƒë‹´ì€ ìœ ì§€ë˜ì§€ë§Œ ìƒˆ ì˜ˆì•½ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

**ì„ í–‰ Scenario:** êµ¬ë… ë§Œë£Œ

---

### Scenario WP9.4-4: ì›”ê°„ ìƒë‹´ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ì°¨ë‹¨ (PREMIUM)

**Given:**
- í•™ë¶€ëª¨ê°€ PREMIUM í”Œëœì´ë‹¤ (ìƒë‹´ 2íšŒ/ì›”).
- ì´ë²ˆ ë‹¬ ì´ë¯¸ 2íšŒ ìƒë‹´ì„ ì™„ë£Œí–ˆë‹¤.

**When:**
- ì¶”ê°€ ìƒë‹´ì„ ì˜ˆì•½í•˜ë ¤ í•œë‹¤.

**Then:**
- "ì´ë²ˆ ë‹¬ ìƒë‹´ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ê°€ í‘œì‹œëœë‹¤.
- ë‹¤ìŒ ì˜µì…˜ì´ ì œê³µëœë‹¤:
  - "ë‹¤ìŒ ë‹¬ê¹Œì§€ ëŒ€ê¸°"
  - "VIPë¡œ ì—…ê·¸ë ˆì´ë“œ (ë¬´ì œí•œ ìƒë‹´)"

**ì„ í–‰ Scenario:** WP9.1-1

---

## ğŸ“Š API ì—”ë“œí¬ì¸íŠ¸ ìš”ì•½

### WP9.0 - í”Œëœ ì¡°íšŒ
| WP | Method | Endpoint | ì„¤ëª… | Role |
|----|--------|----------|------|------|
| WP9.0 | GET | `/plans` | ì „ì²´ í”Œëœ ëª©ë¡ ì¡°íšŒ | PUBLIC |
| WP9.0 | GET | `/plans/:planId` | í”Œëœ ìƒì„¸ ì¡°íšŒ | PUBLIC |

### WP9.1 - ê²°ì œ
| WP | Method | Endpoint | ì„¤ëª… | Role |
|----|--------|----------|------|------|
| WP9.1 | POST | `/subscriptions` | êµ¬ë… ì‹œì‘ (ê²°ì œ ìš”ì²­) | PARENT |
| WP9.1 | POST | `/subscriptions/upgrade` | í”Œëœ ì—…ê·¸ë ˆì´ë“œ | PARENT |
| WP9.1 | POST | `/subscriptions/downgrade` | í”Œëœ ë‹¤ìš´ê·¸ë ˆì´ë“œ | PARENT |
| WP9.1 | POST | `/payments/webhook` | PG Webhook ìˆ˜ì‹  | SYSTEM |

### WP9.2 - êµ¬ë… ê´€ë¦¬
| WP | Method | Endpoint | ì„¤ëª… | Role |
|----|--------|----------|------|------|
| WP9.2 | GET | `/subscriptions/me` | ë‚´ êµ¬ë… ìƒíƒœ ì¡°íšŒ | PARENT |
| WP9.2 | POST | `/subscriptions/cancel` | êµ¬ë… ì·¨ì†Œ | PARENT |
| WP9.2 | POST | `/subscriptions/reactivate` | êµ¬ë… ì¬í™œì„±í™” | PARENT |
| WP9.2 | PUT | `/subscriptions/payment-method` | ê²°ì œ ìˆ˜ë‹¨ ë³€ê²½ | PARENT |
| WP9.2 | GET | `/subscriptions/history` | ê²°ì œ ë‚´ì—­ ì¡°íšŒ | PARENT |

### WP9.3 - ê°€ì¡± í• ì¸
| WP | Method | Endpoint | ì„¤ëª… | Role |
|----|--------|----------|------|------|
| WP9.3 | GET | `/subscriptions/discount-preview` | í• ì¸ ë¯¸ë¦¬ë³´ê¸° | PARENT |

### WP9.4 - í”„ë¦¬ë¯¸ì—„ ì—°ë™
| WP | Method | Endpoint | ì„¤ëª… | Role |
|----|--------|----------|------|------|
| WP9.4 | GET | `/subscriptions/features` | ì‚¬ìš© ê°€ëŠ¥ ê¸°ëŠ¥ ì¡°íšŒ | ALL |
| WP9.4 | GET | `/subscriptions/usage` | ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰ ì¡°íšŒ | PARENT |

---

## ğŸ“¦ í•„ìš”í•œ ìŠ¤í‚¤ë§ˆ ëª¨ë¸

### PlanType Enum
```prisma
enum PlanType {
  FREE
  BASIC
  PREMIUM
  VIP
}
```

### SubscriptionStatus Enum
```prisma
enum SubscriptionStatus {
  ACTIVE
  TRIAL
  PAST_DUE
  CANCELLED
  EXPIRED
}
```

### PaymentStatus Enum
```prisma
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}
```

### Plan ëª¨ë¸ (êµ¬ë… í”Œëœ ì •ì˜)
```prisma
model Plan {
  id           String   @id @default(cuid())
  type         PlanType @unique
  name         String               // "í”„ë¦¬ë¯¸ì—„"
  description  String?  @db.Text
  monthlyPrice Int                  // 49900
  features     String   @db.Text    // JSON: ê¸°ëŠ¥ ëª©ë¡
  consultLimit Int?                 // null = ë¬´ì œí•œ
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  subscriptions Subscription[]

  @@map("plans")
}
```

### Subscription ëª¨ë¸ (ì‚¬ìš©ì êµ¬ë…)
```prisma
model Subscription {
  id              String             @id @default(cuid())
  userId          String
  planId          String
  status          SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt     DateTime?
  cancelAtPeriodEnd Boolean         @default(false)
  discountRate    Float              @default(0)  // ê°€ì¡± í• ì¸ìœ¨
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user     User      @relation(fields: [userId], references: [id])
  plan     Plan      @relation(fields: [planId], references: [id])
  payments Payment[]

  @@map("subscriptions")
}
```

### Payment ëª¨ë¸ (ê²°ì œ ê¸°ë¡)
```prisma
model Payment {
  id             String        @id @default(cuid())
  subscriptionId String
  amount         Int                    // ê²°ì œ ê¸ˆì•¡
  originalAmount Int                    // í• ì¸ ì „ ê¸ˆì•¡
  discountAmount Int           @default(0)
  status         PaymentStatus @default(PENDING)
  pgTransactionId String?               // PG ê±°ë˜ ID
  pgProvider     String?                // "toss", "inicis" ë“±
  failReason     String?
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}
```

### User ëª¨ë¸ ìˆ˜ì • (ê¸°ì¡´)
```prisma
model User {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  // M9: hasPremiumì€ Subscriptionì—ì„œ ë™ì ìœ¼ë¡œ ê³„ì‚°
  // ìºì‹œ ëª©ì ìœ¼ë¡œ ìœ ì§€í•˜ë˜, Subscription ìƒíƒœì™€ ë™ê¸°í™”
  hasPremium Boolean @default(false)
  
  // M9 ê´€ê³„ ì¶”ê°€
  subscriptions Subscription[]
}
```

---

## ğŸ”— M9 â†” ê¸°ì¡´ ëª¨ë“ˆ ì—°ë™

| ê¸°ì¡´ ëª¨ë“ˆ | ì—°ë™ í¬ì¸íŠ¸ |
|----------|------------|
| **M1 Auth** | PARENT Role, User.hasPremium í•„ë“œ |
| **M1 Family** | ê°€ì¡± êµ¬ì„±ì› ìˆ˜ â†’ í• ì¸ìœ¨ ê³„ì‚° |
| **M8 Consultation** | ìƒë‹´ ì˜ˆì•½ ì‹œ êµ¬ë… ìƒíƒœ ì²´í¬ |
| **M8 Consultation** | ì›”ê°„ ìƒë‹´ íšŸìˆ˜ ì²´í¬ (PREMIUM: 2íšŒ) |

---

## ğŸ”„ hasPremium ë™ê¸°í™” ë¡œì§

```typescript
// M9 êµ¬í˜„ í›„ M8ì˜ consultation.service.ts ìˆ˜ì •

async checkPremiumAccess(userId: string): Promise<boolean> {
  const subscription = await this.prisma.subscription.findFirst({
    where: {
      userId,
      status: { in: ['ACTIVE', 'TRIAL', 'PAST_DUE'] },
      currentPeriodEnd: { gte: new Date() },
      plan: { type: { in: ['PREMIUM', 'VIP'] } }
    },
    include: { plan: true }
  });

  return !!subscription;
}

async checkConsultationLimit(userId: string): Promise<{ allowed: boolean; remaining: number }> {
  const subscription = await this.getActiveSubscription(userId);
  
  if (!subscription) {
    return { allowed: false, remaining: 0 };
  }

  if (subscription.plan.type === 'VIP') {
    return { allowed: true, remaining: -1 }; // ë¬´ì œí•œ
  }

  const thisMonthCount = await this.prisma.consultation.count({
    where: {
      parentId: userId,
      status: 'COMPLETED',
      completedAt: { gte: startOfMonth(new Date()) }
    }
  });

  const limit = subscription.plan.consultLimit || 0;
  const remaining = limit - thisMonthCount;

  return { allowed: remaining > 0, remaining };
}
```

---

## âš ï¸ PG ì—°ë™ ì°¸ê³ ì‚¬í•­

### ì§€ì› PG
- Toss Payments (ê¶Œì¥)
- ì•„ì„í¬íŠ¸ (Portone)
- KGì´ë‹ˆì‹œìŠ¤

### Webhook ì²˜ë¦¬ Flow
```
1. ì‚¬ìš©ì â†’ ê²°ì œ ìš”ì²­ â†’ PG
2. PG â†’ ê²°ì œ ê²°ê³¼ Webhook â†’ ë°±ì—”ë“œ
3. ë°±ì—”ë“œ â†’ Webhook ê²€ì¦ â†’ DB ì—…ë°ì´íŠ¸
4. ë°±ì—”ë“œ â†’ ì‚¬ìš©ì ì•Œë¦¼ â†’ í”„ë¡ íŠ¸ì—”ë“œ
```

### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- Webhook ì„œëª… ê²€ì¦ í•„ìˆ˜
- ê²°ì œ ê¸ˆì•¡ ì„œë²„ ì¸¡ ê²€ì¦
- ì¤‘ë³µ Webhook ì²˜ë¦¬ (ë©±ë“±ì„±)






