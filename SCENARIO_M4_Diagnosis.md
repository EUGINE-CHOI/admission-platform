# 📊 M4 — 고입 진단 엔진 시나리오

> **목적**: 학생 데이터(성적/활동/출결/봉사)와 전형 요건을 비교하여 FIT/CHALLENGE/UNLIKELY 평가를 제공하고, 적합한 학교를 추천한다.

---

## 📋 공통 정의

### 진단 레벨 (DiagnosisLevel)
| Level | 설명 | 기준 |
|-------|------|------|
| `FIT` | 적합 (합격 가능성 높음) | 평균 등급 ≤ 커트라인 + 0.5 |
| `CHALLENGE` | 도전 (노력 필요) | 커트라인 + 0.5 < 평균 등급 ≤ 커트라인 + 1.5 |
| `UNLIKELY` | 어려움 (합격 가능성 낮음) | 평균 등급 > 커트라인 + 1.5 |

### 점수 계산 비율
| 항목 | 비율 | 설명 |
|------|:----:|------|
| 내신 (gradeScore) | 60% | 승인된 성적의 평균 등급 기반 |
| 활동 (activityScore) | 20% | 승인된 활동 수/유형 기반 |
| 출결 (attendanceScore) | 10% | 결석/지각 일수 기반 |
| 봉사 (volunteerScore) | 10% | 총 봉사 시간 기반 |

### 최소 데이터 요구사항
| 항목 | 최소 조건 | 미충족 시 |
|------|----------|----------|
| 성적 | 승인된 성적 3과목 이상 | 진단 불가 (400) |
| 등급 | rank 필드 입력된 성적 1개 이상 | 내신 점수 0점 처리 |
| 목표 학교 | 1개 이상 설정 | 목표 학교 진단 불가 |

### 점수 계산 상세

#### 내신 점수 (gradeScore)
```
점수 = (10 - 평균등급) / 9 * 100
예: 평균 2등급 → (10-2)/9*100 = 88.9점
예: 평균 5등급 → (10-5)/9*100 = 55.6점
```

#### 활동 점수 (activityScore)
```
기본 점수 = 활동 개수 × 10 (최대 50점)
유형 보너스:
  - CLUB(동아리): +5점
  - SUBJECT(세특): +10점
  - VOLUNTEER(봉사활동): +5점
  - CAREER(진로): +5점
  - AUTONOMOUS(자율): +5점
최대: 100점
```

#### 출결 점수 (attendanceScore)
```
기본 점수 = 100점
감점:
  - 미인정 결석: -10점/일
  - 질병/기타 결석: -2점/일
  - 지각/조퇴: -1점/회
최소: 0점
```

#### 봉사 점수 (volunteerScore)
```
점수 = 봉사시간 × 5 (최대 100점)
예: 20시간 → 100점
예: 10시간 → 50점
```

---

## 🎯 WP4.0 — 목표 학교 설정 (신규)

### Scenario WP4.0-1: 목표 학교 추가 성공

**Given**: 학생이 로그인되어 있고, 게시된 학교가 존재한다.

**When**: 학생이 특정 학교를 목표 학교로 추가 요청한다.

**Then**: 201 Created, 목표 학교가 DB에 저장되고 "목표 학교로 등록되었습니다" 응답이 반환된다.

**선행 Scenario**: WP1.1-3, M3 학교 등록

---

### Scenario WP4.0-2: 이미 목표 학교로 등록된 학교 중복 추가 실패

**Given**: 학생이 이미 A 학교를 목표 학교로 등록했다.

**When**: 학생이 같은 A 학교를 다시 목표 학교로 추가 요청한다.

**Then**: 409 Conflict와 "이미 목표 학교로 등록되어 있습니다" 메시지가 반환된다.

**선행 Scenario**: WP4.0-1

---

### Scenario WP4.0-3: 목표 학교 삭제 성공

**Given**: 학생이 목표 학교 A를 등록한 상태이다.

**When**: 학생이 A 학교를 목표 학교에서 삭제 요청한다.

**Then**: 200 OK와 "목표 학교에서 삭제되었습니다" 메시지가 반환된다.

**선행 Scenario**: WP4.0-1

---

### Scenario WP4.0-4: 목표 학교 목록 조회 성공

**Given**: 학생이 3개의 학교를 목표 학교로 등록했다.

**When**: 학생이 목표 학교 목록 조회 API를 호출한다.

**Then**: 200 OK와 함께 3개 학교의 정보가 우선순위 순으로 반환된다.

**선행 Scenario**: WP4.0-1

---

### Scenario WP4.0-5: 목표 학교가 없는 경우 빈 목록 반환

**Given**: 학생이 아직 목표 학교를 설정하지 않았다.

**When**: 학생이 목표 학교 목록 조회 API를 호출한다.

**Then**: 200 OK와 빈 배열 `[]`, "목표 학교를 설정해주세요" 메시지가 반환된다.

**선행 Scenario**: WP1.1-3

---

### Scenario WP4.0-6: 목표 학교 우선순위 변경 성공

**Given**: 학생이 A(1순위), B(2순위), C(3순위) 학교를 등록했다.

**When**: 학생이 B 학교의 우선순위를 1순위로 변경 요청한다.

**Then**: 200 OK, 우선순위가 B(1), A(2), C(3)으로 재정렬된다.

**선행 Scenario**: WP4.0-1

---

## 📊 WP4.1 — 내신 기반 진단 로직 V1

### Scenario WP4.1-1: 충분한 성적으로 FIT 판정

**Given**: 학생의 승인된 성적 평균 등급이 2.0이고, 목표 학교의 커트라인이 3.0이다.

**When**: 학생이 해당 학교에 대해 진단 실행을 요청한다.

**Then**: 200 OK와 함께 "FIT" 판정 결과가 반환되고, 진단 결과가 DB에 저장된다.

**선행 Scenario**: WP2.1-1, WP4.0-1

---

### Scenario WP4.1-2: 내신 부족으로 CHALLENGE 판정

**Given**: 학생의 평균 등급이 4.0이고, 목표 학교의 커트라인이 3.0이다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, "CHALLENGE" 판정과 "내신 등급이 커트라인보다 약간 부족합니다" 분석이 반환된다.

**선행 Scenario**: WP2.1-1, WP4.0-1

---

### Scenario WP4.1-3: 내신 크게 부족으로 UNLIKELY 판정

**Given**: 학생의 평균 등급이 6.0이고, 목표 학교의 커트라인이 3.0이다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, "UNLIKELY" 판정과 "내신 등급 개선이 필요합니다" 분석이 반환된다.

**선행 Scenario**: WP2.1-1, WP4.0-1

---

### Scenario WP4.1-4: 승인된 성적 데이터 부족으로 진단 실패

**Given**: 학생의 승인된 성적이 2과목뿐이다 (최소 3과목 필요).

**When**: 학생이 진단 실행을 요청한다.

**Then**: 400 Bad Request와 "진단을 위해 최소 3과목 이상의 승인된 성적이 필요합니다" 메시지가 반환된다.

**선행 Scenario**: WP1.1-3

---

### Scenario WP4.1-5: 목표 학교 미설정으로 특정 학교 진단 불가

**Given**: 학생이 아직 목표 학교를 설정하지 않았다.

**When**: 학생이 특정 학교 진단을 요청한다.

**Then**: 400 Bad Request와 "먼저 목표 학교를 설정해주세요" 메시지가 반환된다.

**선행 Scenario**: WP2.1-1

---

### Scenario WP4.1-6: 학교에 커트라인 정보가 없는 경우

**Given**: 목표 학교에 커트라인(cutoffGrade) 정보가 등록되어 있지 않다.

**When**: 학생이 해당 학교 진단을 요청한다.

**Then**: 200 OK, 내신 점수만 반영된 부분 진단 결과와 "커트라인 정보가 없어 정확한 판정이 어렵습니다" 메시지가 반환된다.

**선행 Scenario**: WP4.0-1

---

## 🎭 WP4.2 — 활동 기반 보조 점수 반영

### Scenario WP4.2-1: 활동 점수가 진단에 반영됨

**Given**: 학생이 동아리 2개, 세특 3개, 봉사활동 1개를 승인받았다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, 활동 점수(activityScore)가 계산되어 종합 점수에 20% 비율로 반영된다.

**선행 Scenario**: WP2.2-1, WP4.1-1

---

### Scenario WP4.2-2: 출결 점수가 진단에 반영됨

**Given**: 학생의 승인된 출결 기록에 미인정 결석 0일, 지각 2회가 있다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, 출결 점수(attendanceScore = 98점)가 종합 점수에 10% 비율로 반영된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.2-3: 봉사 점수가 진단에 반영됨

**Given**: 학생의 승인된 봉사활동 총 시간이 15시간이다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, 봉사 점수(volunteerScore = 75점)가 종합 점수에 10% 비율로 반영된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.2-4: 미인정 결석이 많아 출결 점수 0점

**Given**: 학생의 미인정 결석이 10일 이상이다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, 출결 점수 0점, 약점에 "미인정 결석이 많습니다" 분석이 포함된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.2-5: 활동 데이터 없이 진단 (활동 점수 0점)

**Given**: 학생이 승인된 활동 기록이 없다.

**When**: 학생이 진단을 실행한다.

**Then**: 200 OK, 활동 점수 0점으로 계산되고, 약점에 "활동 기록이 부족합니다" 분석이 포함된다.

**선행 Scenario**: WP4.1-1

---

## 🎯 WP4.3 — 추천 학교 Top3 출력

### Scenario WP4.3-1: 조건에 맞는 추천 학교 3개 반환

**Given**: 게시된 학교가 10개 있고, 학생의 데이터가 충분히 입력되어 있다.

**When**: 학생이 추천 학교 조회 API를 호출한다.

**Then**: 200 OK, 적합도가 높은 순서대로 Top 3 학교가 반환되고, 각 학교별 예상 판정과 추천 이유가 포함된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.3-2: 추천 가능한 학교가 3개 미만인 경우

**Given**: 게시된 학교가 2개뿐이다.

**When**: 학생이 추천 학교 조회 API를 호출한다.

**Then**: 200 OK, 2개 학교만 반환되고, "추천 가능한 학교가 제한적입니다" 메시지가 포함된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.3-3: 게시된 학교가 없는 경우

**Given**: 게시된 학교가 0개이다.

**When**: 학생이 추천 학교 조회 API를 호출한다.

**Then**: 200 OK, 빈 배열과 "현재 추천 가능한 학교가 없습니다" 메시지가 반환된다.

**선행 Scenario**: WP4.1-4 제외

---

### Scenario WP4.3-4: 데이터 부족으로 추천 불가

**Given**: 학생의 승인된 성적이 3과목 미만이다.

**When**: 학생이 추천 학교 조회 API를 호출한다.

**Then**: 400 Bad Request와 "추천을 위해 최소 3과목 이상의 승인된 성적이 필요합니다" 메시지가 반환된다.

**선행 Scenario**: WP1.1-3

---

### Scenario WP4.3-5: 지역 필터링된 추천

**Given**: 학생이 "서울" 지역으로 필터를 설정했다.

**When**: 학생이 추천 학교 조회 API를 호출한다.

**Then**: 200 OK, 서울 지역 학교 중 Top 3가 반환된다.

**선행 Scenario**: WP4.3-1

---

## 📄 WP4.4 — 진단 결과 조회 및 히스토리

### Scenario WP4.4-1: 최근 진단 결과 조회 성공

**Given**: 학생이 이전에 진단을 실행한 기록이 있다.

**When**: 학생이 최근 진단 결과 조회 API를 호출한다.

**Then**: 200 OK, 가장 최근 진단 결과(종합 점수, 세부 점수, 강점/약점, 추천사항)가 반환된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.4-2: 진단 히스토리 목록 조회

**Given**: 학생이 3번의 진단을 실행한 기록이 있다.

**When**: 학생이 진단 히스토리 조회 API를 호출한다.

**Then**: 200 OK, 최근순으로 정렬된 3개의 진단 결과 목록이 반환된다.

**선행 Scenario**: WP4.1-1 (3회 실행)

---

### Scenario WP4.4-3: 진단 기록이 없는 경우

**Given**: 학생이 아직 진단을 실행한 적이 없다.

**When**: 학생이 진단 결과 조회 API를 호출한다.

**Then**: 200 OK, 빈 결과와 "아직 진단을 실행하지 않았습니다" 메시지가 반환된다.

**선행 Scenario**: WP1.1-3

---

### Scenario WP4.4-4: 특정 학교 진단 결과만 조회

**Given**: 학생이 A, B 두 학교에 대해 진단을 실행했다.

**When**: 학생이 A 학교 진단 결과만 조회 요청한다.

**Then**: 200 OK, A 학교에 대한 진단 결과만 반환된다.

**선행 Scenario**: WP4.1-1

---

### Scenario WP4.4-5: 학부모가 자녀 진단 결과 조회

**Given**: 학부모와 자녀가 가족으로 연결되어 있고, 자녀가 진단을 실행했다.

**When**: 학부모가 자녀 진단 결과 조회 API를 호출한다.

**Then**: 200 OK, 자녀의 진단 결과가 반환된다.

**선행 Scenario**: WP1.3-2, WP4.1-1

---

### Scenario WP4.4-6: 학부모가 연결되지 않은 학생 진단 조회 차단

**Given**: 학부모 A와 학생 B는 가족 관계가 아니다.

**When**: 학부모 A가 학생 B의 진단 결과 조회를 요청한다.

**Then**: 403 Forbidden과 "접근 권한이 없습니다" 메시지가 반환된다.

**선행 Scenario**: WP1.1-9

---

### Scenario WP4.4-7: 학부모가 자녀 추천 학교 조회

**Given**: 학부모와 자녀가 가족으로 연결되어 있다.

**When**: 학부모가 자녀의 추천 학교 목록 조회 API를 호출한다.

**Then**: 200 OK, 자녀에게 추천된 학교 목록이 반환된다.

**선행 Scenario**: WP1.3-2, WP4.3-1

---

## 📊 시나리오 의존성 맵

```
[M2 학생 데이터] ──────────────────────────────────────┐
    ├── WP2.1 (성적)                                   │
    ├── WP2.2 (활동)                                   │
    ├── WP2.3 (독서)                                   ▼
    └── 출결/봉사                             ┌────────────────┐
                                              │  WP4.0 목표학교 │
[M3 학교 데이터] ─────────────────────────────┤     설정       │
    └── 학교/전형/커트라인                    └───────┬────────┘
                                                      │
                                              ┌───────▼────────┐
                                              │  WP4.1 내신진단 │
                                              │  (필수 선행)    │
                                              └───────┬────────┘
                                                      │
                    ┌─────────────────────────────────┼─────────────────────┐
                    │                                 │                     │
            ┌───────▼────────┐               ┌───────▼────────┐    ┌───────▼────────┐
            │  WP4.2 활동점수 │               │  WP4.3 추천Top3 │    │  WP4.4 결과조회 │
            │  (보조 반영)    │               │  (전체 학교)    │    │  (히스토리)    │
            └────────────────┘               └────────────────┘    └────────────────┘
```

---

## 📝 API 엔드포인트 요약

| WP | Method | Endpoint | 설명 | 권한 |
|----|--------|----------|------|------|
| WP4.0 | POST | `/diagnosis/target-schools` | 목표 학교 추가 | STUDENT |
| WP4.0 | DELETE | `/diagnosis/target-schools/:schoolId` | 목표 학교 삭제 | STUDENT |
| WP4.0 | GET | `/diagnosis/target-schools` | 목표 학교 목록 | STUDENT |
| WP4.0 | PATCH | `/diagnosis/target-schools/:schoolId/priority` | 우선순위 변경 | STUDENT |
| WP4.1 | POST | `/diagnosis/run` | 진단 실행 | STUDENT |
| WP4.1 | POST | `/diagnosis/run/:schoolId` | 특정 학교 진단 | STUDENT |
| WP4.3 | GET | `/diagnosis/recommendations` | 추천 학교 Top3 | STUDENT |
| WP4.3 | GET | `/diagnosis/recommendations?region=서울` | 지역별 추천 | STUDENT |
| WP4.4 | GET | `/diagnosis/results` | 진단 결과 목록 | STUDENT |
| WP4.4 | GET | `/diagnosis/results/latest` | 최근 진단 결과 | STUDENT |
| WP4.4 | GET | `/diagnosis/results/:schoolId` | 학교별 진단 결과 | STUDENT |
| WP4.4 | GET | `/diagnosis/children/:childId/results` | 자녀 진단 결과 | PARENT |
| WP4.4 | GET | `/diagnosis/children/:childId/recommendations` | 자녀 추천 학교 | PARENT |

---

## 📊 응답 예시

### 진단 결과 (WP4.1)
```json
{
  "diagnosis": {
    "id": "diag_xxx",
    "schoolId": "school_xxx",
    "schoolName": "서울과학고",
    "level": "CHALLENGE",
    "score": 72.5,
    "gradeScore": 78,
    "activityScore": 65,
    "attendanceScore": 98,
    "volunteerScore": 50,
    "strengths": ["내신 관리가 양호합니다", "출결이 우수합니다"],
    "weaknesses": ["활동 기록이 부족합니다", "봉사 시간이 부족합니다"],
    "recommendations": ["동아리 활동을 추가해보세요", "봉사활동 시간을 20시간 이상으로 늘려보세요"],
    "createdAt": "2025-12-05T10:00:00Z"
  }
}
```

### 추천 학교 (WP4.3)
```json
{
  "recommendations": [
    {
      "rank": 1,
      "schoolId": "school_a",
      "schoolName": "A 고등학교",
      "type": "SPECIAL",
      "region": "서울",
      "level": "FIT",
      "score": 85.2,
      "reason": "내신과 활동이 전형 요건에 적합합니다"
    },
    {
      "rank": 2,
      "schoolId": "school_b",
      "schoolName": "B 고등학교",
      "type": "AUTONOMOUS",
      "region": "서울",
      "level": "CHALLENGE",
      "score": 72.1,
      "reason": "활동을 보강하면 합격 가능성이 높아집니다"
    }
  ],
  "message": null
}
```

---

> 📝 **Note**: 이 시나리오는 BDD(Behavior-Driven Development) 형식으로 작성되었습니다.
> 각 시나리오는 독립적인 테스트 케이스로 구현될 수 있습니다.
> 점수 계산 로직은 MVP 기준이며, 추후 AI 기반 고도화가 가능합니다.

